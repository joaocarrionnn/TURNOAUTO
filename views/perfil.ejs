<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <%- include('partials/head', {title: 'Meu Perfil'}); %>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    .profile-picture {
      transition: all 0.3s ease;
    }
    .profile-picture:hover {
      transform: scale(1.05);
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .input-field:focus {
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);

      /* Estilo para os botões de tema */
#light-theme-btn, #dark-theme-btn {
  transition: all 0.3s ease;
}

#light-theme-btn {
  border-color: #d1d5db;
  background-color: #ffffff;
  color: #111827;
}

#dark-theme-btn {
  border-color: #4b5563;
  background-color: #1f2937;
  color: #ffffff;
}

.active-theme {
  background-color: #3b82f6 !important;
  color: white !important;
  border-color: #3b82f6 !important;
}
    }
  </style>
  <script>
    // Função para mudar o tema
function changeTheme(theme) {
  // Salva a preferência no localStorage
  localStorage.setItem('theme', theme);
  
  // Aplica o tema em todas as páginas
  document.documentElement.setAttribute('data-theme', theme);
  
  // Atualiza o ícone do tema
  updateThemeIcon(theme);
}

// Função para atualizar o ícone do tema ativo
function updateThemeIcon(theme) {
  const lightBtn = document.getElementById('light-theme-btn');
  const darkBtn = document.getElementById('dark-theme-btn');
  
  if (theme === 'light') {
    lightBtn.classList.add('bg-blue-100', 'border-blue-300');
    darkBtn.classList.remove('bg-blue-100', 'border-blue-300');
  } else {
    darkBtn.classList.add('bg-blue-100', 'border-blue-300');
    lightBtn.classList.remove('bg-blue-100', 'border-blue-300');
  }
}

// Inicializa o ícone do tema
document.addEventListener('DOMContentLoaded', function() {
  const savedTheme = localStorage.getItem('theme') || 'light';
  updateThemeIcon(savedTheme);
});
  </script>
</head>
<body class="bg-gray-50">
  <%- include('partials/header', {user: user}); %>
  
  <main class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
      <!-- Cabeçalho do Perfil -->
      <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-8">
        <div class="flex items-center mb-4 md:mb-0">
          <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Meu Perfil</h1>
          <% if (profile.role === 'admin') { %>
            <span class="ml-3 bg-yellow-100 text-yellow-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">ADMIN</span>
          <% } %>
        </div>
        <div class="flex space-x-3">
          <a href="/" class="flex items-center px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors">
            <i class="fas fa-arrow-left mr-2"></i> Voltar
          </a>
        </div>
      </div>
      
      <!-- Mensagens de erro/sucesso -->
      <% if (typeof error !== 'undefined' && error) { %>
        <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded-lg">
          <div class="flex items-center">
            <i class="fas fa-exclamation-circle mr-2"></i>
            <p><%= error %></p>
          </div>
        </div>
      <% } %>
      
      <% if (typeof success !== 'undefined' && success) { %>
        <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mb-6 rounded-lg">
          <div class="flex items-center">
            <i class="fas fa-check-circle mr-2"></i>
            <p><%= success %></p>
          </div>
        </div>
      <% } %>
      
      <div class="bg-white rounded-xl shadow-md overflow-hidden">
        <div class="flex flex-col md:flex-row">
          <!-- Barra lateral -->
          <div class="w-full md:w-64 bg-indigo-50 dark:bg-gray-800 p-6 border-b md:border-b-0 md:border-r border-gray-200 dark:border-gray-700">
            <div class="flex flex-col items-center">
              <div class="relative mb-4 group">
                <div class="h-32 w-32 rounded-full overflow-hidden border-4 border-white dark:border-gray-700 shadow-lg profile-picture dark:profile-picture-dark">
                  <img src="<%= profile.profile_picture || '/images/default-profile.png' %>" 
                       alt="Foto de perfil" 
                       class="h-full w-full object-cover">
                </div>
                <label for="foto_perfil" class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer bg-black/50 rounded-full">
                  <i class="fas fa-camera text-white text-xl"></i>
                </label>
              </div>
              
              <form id="upload-form" action="/perfil/upload-foto" method="POST" enctype="multipart/form-data">
                <input type="file" id="foto_perfil" name="foto_perfil" accept="image/*" class="hidden">
              </form>
            
              <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-100 text-center"><%= profile.name %></h2>
              <p class="text-sm text-gray-500 dark:text-gray-400 mt-1"><%= profile.email %></p>
              
              <div class="mt-4 flex space-x-2">
                <form action="/perfil/remover-foto" method="POST" onsubmit="return confirm('Tem certeza que deseja remover sua foto de perfil?');">
                  <button type="submit" class="text-xs text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300 flex items-center">
                    <i class="fas fa-trash-alt mr-1"></i> Remover Foto
                  </button>
                </form>
              </div>
            </div>
            
            <div class="mt-8">
              <nav class="space-y-1">
                <button onclick="openTab('informacoes')" class="w-full flex items-center px-4 py-2 text-sm font-medium rounded-lg text-indigo-700 dark:text-indigo-200 bg-indigo-100 dark:bg-gray-700">
                  <i class="fas fa-user-circle mr-3"></i> Informações Básicas
                </button>
                <button onclick="openTab('seguranca')" class="w-full flex items-center px-4 py-2 text-sm font-medium rounded-lg text-gray-600 dark:text-gray-300 hover:text-indigo-700 dark:hover:text-indigo-200 hover:bg-indigo-50 dark:hover:bg-gray-700">
                  <i class="fas fa-lock mr-3"></i> Segurança
                </button>
                <button onclick="openTab('preferencias')" class="w-full flex items-center px-4 py-2 text-sm font-medium rounded-lg text-gray-600 dark:text-gray-300 hover:text-indigo-700 dark:hover:text-indigo-200 hover:bg-indigo-50 dark:hover:bg-gray-700">
                  <i class="fas fa-cog mr-3"></i> Preferências
                </button>
              </nav>
            </div>
          </div>
          
          <!-- Conteúdo principal -->
          <div class="flex-1 p-6">
            <!-- Aba Informações Básicas -->
            <div id="informacoes" class="tab-content active">
              <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-user-circle text-indigo-600 mr-2"></i> Informações Pessoais
              </h3>
              
              <form action="/perfil/atualizar" method="POST">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Nome Completo</label>
                    <input type="text" id="name" name="name" value="<%= profile.name %>" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg input-field focus:ring-indigo-500 focus:border-indigo-500">
                  </div>
                  
                  <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="email" name="email" value="<%= profile.email %>" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg input-field focus:ring-indigo-500 focus:border-indigo-500">
                  </div>
                  
                  <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Função</label>
                    <div class="px-4 py-2 bg-gray-100 rounded-lg">
                      <p class="text-gray-800">
                        <%= profile.role === 'admin' ? 'Administrador' : 'Usuário' %>
                      </p>
                    </div>
                  </div>
                </div>
                
                <div class="mt-6 flex justify-end">
                  <button type="submit" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors flex items-center">
                    <i class="fas fa-save mr-2"></i> Salvar Alterações
                  </button>
                </div>
              </form>
            </div>
            
            <!-- Aba Segurança -->
            <div id="seguranca" class="tab-content">
              <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-lock text-indigo-600 mr-2"></i> Segurança da Conta
              </h3>
              
              <form action="/perfil/alterar-senha" method="POST">
                <div class="space-y-4">
                  <div>
                    <label for="senha_atual" class="block text-sm font-medium text-gray-700 mb-1">Senha Atual</label>
                    <div class="relative">
                      <input type="password" id="senha_atual" name="senha_atual" 
                             class="w-full px-4 py-2 border border-gray-300 rounded-lg input-field focus:ring-indigo-500 focus:border-indigo-500">
                      <button type="button" class="absolute right-3 top-2.5 text-gray-400 hover:text-gray-600 toggle-password" data-target="senha_atual">
                        <i class="fas fa-eye"></i>
                      </button>
                    </div>
                  </div>
                  
                  <div>
                    <label for="nova_senha" class="block text-sm font-medium text-gray-700 mb-1">Nova Senha</label>
                    <div class="relative">
                      <input type="password" id="nova_senha" name="nova_senha" 
                             class="w-full px-4 py-2 border border-gray-300 rounded-lg input-field focus:ring-indigo-500 focus:border-indigo-500">
                      <button type="button" class="absolute right-3 top-2.5 text-gray-400 hover:text-gray-600 toggle-password" data-target="nova_senha">
                        <i class="fas fa-eye"></i>
                      </button>
                    </div>
                    <p class="mt-1 text-xs text-gray-500">Mínimo de 6 caracteres</p>
                  </div>
                  
                  <div>
                    <label for="confirmar_senha" class="block text-sm font-medium text-gray-700 mb-1">Confirmar Nova Senha</label>
                    <div class="relative">
                      <input type="password" id="confirmar_senha" name="confirmar_senha" 
                             class="w-full px-4 py-2 border border-gray-300 rounded-lg input-field focus:ring-indigo-500 focus:border-indigo-500">
                      <button type="button" class="absolute right-3 top-2.5 text-gray-400 hover:text-gray-600 toggle-password" data-target="confirmar_senha">
                        <i class="fas fa-eye"></i>
                      </button>
                    </div>
                  </div>
                </div>
                
                <div class="mt-6 flex justify-end">
                  <button type="submit" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors flex items-center">
                    <i class="fas fa-key mr-2"></i> Alterar Senha
                  </button>
                </div>
              </form>
            </div>
            
            <!-- Aba Preferências -->
            <div id="preferencias" class="tab-content">
              <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-cog text-indigo-600 mr-2"></i> Preferências
              </h3>
              
              <div class="space-y-6">
                <div>
                  <h4 class="text-md font-medium text-gray-800 mb-3">Notificações</h4>
                  <div class="space-y-3">
                    <div class="flex items-center">
                      <input type="checkbox" id="notificacoes_email" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                      <label for="notificacoes_email" class="ml-3 block text-sm text-gray-700">Receber notificações por email</label>
                    </div>
                    <div class="flex items-center">
                      <input type="checkbox" id="notificacoes_push" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                      <label for="notificacoes_push" class="ml-3 block text-sm text-gray-700">Receber notificações no navegador</label>
                    </div>
                  </div>
                </div>
                
                <div>
                  <h4 class="text-md font-medium text-gray-800 mb-3">Tema</h4>
                  <div class="flex space-x-4">
                    <button id="light-theme-btn" onclick="changeTheme('light')" class="px-4 py-2 border rounded-lg flex items-center active-theme">
                      <i class="fas fa-sun mr-2 text-yellow-500"></i> Claro
                    </button>
                    <button id="dark-theme-btn" onclick="changeTheme('dark')" class="px-4 py-2 border rounded-lg flex items-center">
                      <i class="fas fa-moon mr-2 text-indigo-300"></i> Escuro
                    </button>
                  </div>
                </div>
              </div>
              
              <div class="mt-6 flex justify-end">
                <button class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors flex items-center">
                  <i class="fas fa-save mr-2"></i> Salvar Preferências
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <%- include('partials/footer'); %>
  
  <script>
    // Controle das abas
    function openTab(tabId) {
      // Esconde todas as abas
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Mostra a aba selecionada
      document.getElementById(tabId).classList.add('active');
      
      // Atualiza o estilo dos botões
      document.querySelectorAll('nav button').forEach(button => {
        if (button.getAttribute('onclick').includes(tabId)) {
          button.classList.remove('text-gray-600', 'hover:text-indigo-700', 'hover:bg-indigo-50');
          button.classList.add('text-indigo-700', 'bg-indigo-100');
        } else {
          button.classList.remove('text-indigo-700', 'bg-indigo-100');
          button.classList.add('text-gray-600', 'hover:text-indigo-700', 'hover:bg-indigo-50');
        }
      });
    }
    
    // Toggle para mostrar/esconder senha
    document.querySelectorAll('.toggle-password').forEach(button => {
      button.addEventListener('click', function() {
        const targetId = this.getAttribute('data-target');
        const input = document.getElementById(targetId);
        const icon = this.querySelector('i');
        
        if (input.type === 'password') {
          input.type = 'text';
          icon.classList.remove('fa-eye');
          icon.classList.add('fa-eye-slash');
        } else {
          input.type = 'password';
          icon.classList.remove('fa-eye-slash');
          icon.classList.add('fa-eye');
        }
      });
    });
    
    // Upload de foto de perfil - versão corrigida
  document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('foto_perfil');
    
    if (fileInput) {
      fileInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
          // Validação do arquivo
          const validTypes = ['image/jpeg', 'image/png', 'image/gif'];
          if (!validTypes.includes(this.files[0].type)) {
            alert('Por favor, selecione uma imagem (JPEG, PNG ou GIF)');
            return;
          }
          
          // Limite de tamanho (5MB)
          if (this.files[0].size > 5 * 1024 * 1024) {
            alert('A imagem deve ter no máximo 5MB');
            return;
          }
          
          // Mostra preview
          const reader = new FileReader();
          reader.onload = function(e) {
            document.querySelector('.profile-picture img').src = e.target.result;
          }
          reader.readAsDataURL(this.files[0]);
          
          // Cria FormData e envia via AJAX
          const formData = new FormData();
          formData.append('foto_perfil', this.files[0]);
          
          fetch('/perfil/upload-foto', {
            method: 'POST',
            body: formData
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              window.location.reload();
            } else {
              alert(data.error || 'Erro ao atualizar a foto');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Erro ao enviar a foto');
          });
        }
      });
    }
  });
    // Abre o seletor de arquivos ao clicar no ícone da câmera
    document.querySelector('label[for="foto_perfil"]').addEventListener('click', function(e) {
      e.preventDefault();
      document.getElementById('foto_perfil').click();
    });
  </script>
</body>
</html>